name: Release Windows Executable

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*' # v1.0.0, v1.2.3 ë“±ì˜ íƒœê·¸ê°€ í‘¸ì‹œë  ë•Œ ì‹¤í–‰
  workflow_dispatch: # GitHub UIì—ì„œ ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  build-and-release:
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@af1da67850ed9a4cedd57bfd976089dd991e2582 # v4.0.0

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        shell: bash

      - name: Build with Gradle
        run: ./gradlew build -x test

      - name: Run tests
        run: ./gradlew test

      - name: Get version from tag
        id: get_version
        run: |
          if ($env:GITHUB_REF -match 'refs/tags/v(.*)') {
            $version = $matches[1]
          } else {
            $version = "1.0.0"
          }
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Create Windows executable with jpackage
        run: ./gradlew jpackage
        env:
          APP_VERSION: ${{ steps.get_version.outputs.VERSION }}

      - name: Compress executable directory
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          Compress-Archive -Path app\build\jpackage\Tetris\* -DestinationPath "Tetris-Windows-v$version.zip"
        shell: pwsh

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: Tetris-Windows-*.zip
          body: |
            ## ğŸ® Tetris Windows ì‹¤í–‰ íŒŒì¼

            ### ğŸ“¦ ì„¤ì¹˜ ë°©ë²•
            1. `Tetris-Windows-v${{ steps.get_version.outputs.VERSION }}.zip` íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤
            2. ì••ì¶•ì„ ì›í•˜ëŠ” ìœ„ì¹˜ì— í’€ì–´ì¤ë‹ˆë‹¤
            3. `Tetris.exe`ë¥¼ ë”ë¸”í´ë¦­í•˜ì—¬ ì‹¤í–‰í•©ë‹ˆë‹¤

            ### âœ¨ íŠ¹ì§•
            - âœ… **Java ì„¤ì¹˜ ë¶ˆí•„ìš”** - JREê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤
            - âœ… **ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥** - ì¶”ê°€ ì„¤ì •ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤
            - âœ… **ì•„ì´ì½˜ ì ìš©** - í…ŒíŠ¸ë¦¬ìŠ¤ ì „ìš© ì•„ì´ì½˜ì´ ì ìš©ë˜ì–´ ìˆìŠµë‹ˆë‹¤

            ### ğŸ’» ìµœì†Œ ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­
            - Windows 10 ì´ìƒ
            - ì•½ 150MBì˜ ë””ìŠ¤í¬ ê³µê°„

            ### ğŸ¯ ê²Œì„ ì¡°ì‘ë²•
            - **ì´ë™**: ì¢Œ/ìš° ë°©í–¥í‚¤
            - **íšŒì „**: Z
            - **ì†Œí”„íŠ¸ ë“œë¡­**: ì•„ë˜ ë°©í–¥í‚¤
            - **í•˜ë“œ ë“œë¡­**: X
            - **ì¼ì‹œì •ì§€**: P
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
